import os
import sys

from httpy import Request
from httpy.couplers.cgi.request import CGIRequest
from httpy.couplers.utils import add_api, make_deliver


class Coupler:
    """Implement a coupler for CGI deployments.
    """

    def __init__(self, responder):
        root = os.path.realpath(os.path.dirname(os.environ['SCRIPT_FILENAME']))
        uri = os.environ['SCRIPT_NAME']
        responder = add_api(responder, root, uri)

        def make_request():
            cgi_request = CGIRequest(os.environ, sys.stdin)
            return Request(cgi_request)

        self.deliver = make_deliver( make_request
                                   , responder
                                   , sys.stdout
                                    )

    def go(self):
        self.deliver()
