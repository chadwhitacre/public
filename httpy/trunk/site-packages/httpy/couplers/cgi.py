"""Implement a CGI coupler for httpy.
"""
import os
import sys
import urlparse
from email import message_from_string

import httpy
from httpy._zope.interface import implements
from httpy.interfaces import IRequest


class CGIRequest:
    """Reconstruct an httpy.Request from the environment and stdin.
    """

    implements(IRequest)

    def __init__(self, stdin, environ, responder):
        """Takes a reference to the responder.
        """

        # Request-Line
        # ============

        method = environ['REQUEST_METHOD']

        path = environ.get('PATH_INFO', None)
        query = environ.get('QUERY_STRING', '')
        if query:
            query = '?' + query
        raw_uri = responder.uri + path + query
        uri = urlparse.urlparse(raw_uri)
        keys = ( 'scheme'
               , 'netloc'
               , 'path'
               , 'parameters'
               , 'query'
               , 'fragment'
                )
        _uri = {}
        for i in range(len(uri)):
            k = keys[i]
            v = uri[i]
            _uri[k] = v
        uri = _uri

        http_version = environ['SERVER_PROTOCOL']

        raw_line = "%s %s %s\r\n" % (method, raw_uri, http_version)


        # Headers
        # =======

        headers = []
        for k, v in environ.iteritems():
            k = k.lower()
            if k.startswith('http_'):
                as_string = "%s: %s" % (k[5:].replace('_','-'), v)
                headers.append(as_string)
        raw_headers = '\r\n'.join(headers)
        raw_headers += '\r\n'
        headers = message_from_string(raw_headers)


        # Body
        # ====

        raw_body = stdin.read()


        # Save the API we want.
        # =====================

        raw = raw_line + raw_headers + raw_body

        self.raw = raw
        self.raw_line = raw_line
        self.raw_headers = raw_headers
        self.raw_body = raw_body

        self.method = method
        self.uri = uri
        self.path = path
        self.headers = headers


class Coupler:
    """A coupler for CGI deployments.
    """

    def __init__(self, responder):
        self.responder = responder
        self.responder.uri = os.environ['SCRIPT_NAME']
        self.responder.root = os.path.dirname(environ['SCRIPT_FILENAME'])
        self.deliver = httpy.couplers.utils.make_deliver( self.make_request
                                                        , self.responder
                                                        , sys.stdout
                                                         )

    def make_request(self):
        cgi_request = CGIRequest(sys.stdin, os.environ, self.responder)
        return httpy.Request(cgi_request)

    def go(self):
        self.deliver()
