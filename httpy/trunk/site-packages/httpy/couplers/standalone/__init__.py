"""This coupler starts a stand-alone web server.
"""
import logging
import os
import sys

import httpy
from httpy import responders
from httpy.couplers.standalone.config import Config, ConfigError
from httpy.couplers.standalone.server import Server, RestartingServer


class Coupler:

    def __init__(self, responder, argv=None):
        """Takes an IResponder instance, an IConfig class, and an argv.

        This was originally inspired by Guido's main() function:

            http://www.artima.com/weblogs/viewpost.jsp?thread=4829

        """

        # Read in configuration.
        # ======================

        argv = argv or sys.argv[1:]
        try:
            config = Config(argv)
        except ConfigError, err:
            print >> sys.stderr, err.msg
            print >> sys.stderr, "`man 1 httpy' for usage."
            raise SystemExit(2)


        # Start a server.
        # ===============

        plain_jane = (  (httpy.mode.IS_DEPLOYMENT)
                     or (sys.platform == 'win32')
                     or ('HTTPY_PLAIN_JANE' in os.environ)
                     or (sys.argv == ['']) # called interactively
                       )
        ServerClass = plain_jane and Server or RestartingServer
        self.server = ServerClass(config, responder)


    def go(self):
        """Wheeeeee!
        """
        self.server.start()
