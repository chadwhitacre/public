"""Use jonpy's fcgi module to couple httpy to FastCGI servers.
"""
import os
import sys

import httpy
from httpy import Request
from httpy.couplers.cgi.request import CGIRequest
from httpy.couplers.fastcgi import jon
from httpy.couplers.utils import make_deliver


class Handler:

    responder = None # jon.fcgi.Server takes a class, not an instance.

    def traceback(self, req):
        """Display a traceback, req is a jonpy Request object.
        """
        req.traceback()

    def process(self, req):
        if not hasattr(req, "_Request__connection"):
            # hack!
            raise StandardError("Not running as fcgi.")
        self.deliver = make_deliver( self.make_request
                                   , self.responder
                                   , req
                                    )
        req.clear_headers()
        self.deliver(req.stdin, req.environ)

    def make_request(self, rfile, environ):
        fcgi_request = CGIRequest(rfile, environ, self.responder)
        return httpy.couplers.standalone.request(fcgi_request)


class Coupler:
    """Adapt jonpy and httpy to each other.
    """

    def __init__(self, Responder):
        responder = Responder()
        root = os.path.dirname(environ['SCRIPT_FILENAME'])
        uri = environ['SCRIPT_NAME']
        responder = add_api(responder, root, uri)
        Handler.responder = responder

    def go(self):
        server = jon.fcgi.Server({jon.fcgi.FCGI_RESPONDER: Handler})
        server.run()
