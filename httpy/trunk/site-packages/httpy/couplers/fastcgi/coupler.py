"""Use jonpy's fcgi module to couple httpy to fastcgi servers.
"""
import os
import sys

import httpy
from httpy import Request
from httpy.couplers.cgi import CGIRequest
from httpy.couplers.fastcgi import jon
from httpy.couplers.utils import make_deliver


class Handler:

    responder = None

    def traceback(self, req):
        """Display a traceback, req is a Request object.
        """
        req.traceback()

    def process(self, req):
        if not hasattr(req, "_Request__connection"):
            raise StandardError("Not running as fcgi.")
        self.deliver = make_deliver( self.make_request
                                   , self.responder
                                   , req
                                   #, req._Request__connection
                                    )
        req.clear_headers()
        self.deliver(req.stdin, req.environ)

    def make_request(self, rfile, environ):
        self.responder.uri = environ['SCRIPT_NAME']
        self.responder.root = os.path.dirname(environ['SCRIPT_FILENAME'])
        fcgi_request = CGIRequest(rfile, environ, self.responder)
        return httpy.Request(fcgi_request)


class Coupler:
    """Adapt jonpy to httpy.
    """

    # ICoupler contracts.
    # ===================

    def __init__(self, responder):
        self.responder = responder
        setattr(Handler, 'responder', responder)

    def go(self):
        server = jon.fcgi.Server({jon.fcgi.FCGI_RESPONDER: Handler})
        server.run()


