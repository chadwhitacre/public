"""This module implements an httpy application.

By implementing the basic case -- serving static files from the filesystem -- we
demonstrate how to construct an httpy application.

"""

import logging
import mimetypes
import rfc822
import os
import stat
import time

from httpy._zope.interface import implements, moduleProvides

from httpy.interfaces import IApp, IApplication
from httpy.Response import Response


moduleProvides(IApp)


# Logging
# =======
logger = logging.getLogger('httpy.DefaultApp')


class Application:
    """This is httpy's default request respondor.
    """

    implements(IApplication)

    name = 'default httpy app'

    def __init__(self):
        from httpy import utils # dodge circular import -- still a problem?
        self.uri_to_fs = utils.uri_to_fs

    def __repr__(self):
        return "<%s>" % self.name
    __str__ = __repr__


    def respond(self, request):
        """Given an httpy.Request, raise an httpy.Response.
        """
        fs_path = self.uri_to_fs( self.site_root
                                , self.fs_root
                                , self.uri_root
                                , request.path
                                , defaults = ('index.html', 'index.htm')
                                 )
        ims = request.message.get('If-Modified-Since', '')
        self.serve_static(fs_path, ims)


    def serve_static(self, fs_path, ims):
        """Given a filesystem path to a static resource, serve it.

        This is factored out for easier reuse.

        """

        # Get basic info from the filesystem and start building a response.
        # =================================================================

        mtime = os.stat(fs_path)[stat.ST_MTIME]
        mimetypes.add_type('image/x-icon', '.ico')
        guess = mimetypes.guess_type(fs_path)[0]
        content_type = guess or 'text/plain'
        response = Response(200)


        # Support 304s, but only in deployment mode.
        # ==========================================

        if self.deploy_mode:
            if ims:
                mod_since = rfc822.parsedate(ims)
                last_modified = time.gmtime(mtime)
                if last_modified[:6] <= mod_since[:6]:
                    response.code = 304


        # Finish building the response and raise it.
        # ========================================

        response.headers['Last-Modified'] = rfc822.formatdate(mtime)
        response.headers['Content-Type'] = content_type
        if response.code != 304:
            response.body = file(fs_path, 'rb').read()
        raise response


    def close(self):
        logger.debug("closing DefaultApp")


DefaultApplication = Application
