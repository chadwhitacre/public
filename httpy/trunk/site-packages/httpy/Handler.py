import traceback
from SocketServer import StreamRequestHandler

from httpy.Endings import Ending
from httpy.Request import Request
from httpy.Response import Response
from httpy.app import Transaction


class Handler(StreamRequestHandler):

    def handle(self):

        try:
            request = Request(self.rfile)
            response = Response(self.wfile)
            transaction = self.get_transaction(request)
            transaction.process(request, response)
        except Ending, ending:
            self.end(ending)
        except:
            self.fail()

    def end(self, ending):
        print ending

    def fail(self):
        print traceback.format_exc()

    def get_transaction(self, request):
        transaction = Transaction(request)
        return transaction
