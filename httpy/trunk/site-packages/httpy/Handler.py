import traceback
from SocketServer import StreamRequestHandler

from httpy.Endings import Ending
from httpy.Request import Request
from httpy.Response import Response
from httpy.app import Transaction


class Handler(StreamRequestHandler):

    def handle(self):

        try:
            request = Request(self.server.config, self.rfile)
            response = Response(self.server.config, self.wfile)
            transaction = self.get_transaction(config, request)
            transaction.process(request, response)
        except Response, response:
            self.respond(response)
        except:
            self.fail()

    def respond(self, response):
        print ending

    def fail(self):
        print traceback.format_exc()

    def get_transaction(self, request):
        transaction = Transaction(request)
        return transaction
