from httpy.NicolasLehuen import Cache
from httpy.utils import get_transaction


class TransactionCache(Cache):
    """A cached mapping of magic directory paths to Transaction objects.

    The cache is populated when the server is instantiated. We never expire
    cached values, so the only way to repopulate the cache is by restarting the
    server. Instead, though, we only use this cache when in deployment mode. We
    call get_transaction directly for each request in development mode.

    """

    def check(self, __, entry):
        if hasattr(entry, 'loaded'):
            return None
        else:
            setattr(entry, 'loaded', True)
            return get_transaction(__)

    def build(self, __, opened, entry):
        return opened
