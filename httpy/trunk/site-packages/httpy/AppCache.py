import linecache
import sys

import zope.interface

from httpy import DefaultApp
from httpy.interfaces import IApp
from httpy.NicolasLehuen import Cache
from httpy.utils import log, Gaoler


gaoler = Gaoler()


class AppCache(Cache):
    """A cached mapping of magic directory paths to app objects.
    """

    def __init__(self, mode):
        """Takes a mode per httpy.Config.

        The maxsize of 1000 is just a safety belt. If you trip it on purpose,
        you are blowing my mind. Why on earth are you building a website with
        more than a thousand distinct applications?

        """

        Cache.__init__(self, max_size=1000)
        self.dev_mode = mode == 'development'


    def check(self, __, entry):
        """Given a magic dir and an entry, return an app or None.

        In development mode, this cache is just a pass-through for get_app.

        """

        if not self.dev_mode:
            if hasattr(entry, 'loaded'):
                return None
            else:
                setattr(entry, 'loaded', True)
                return self.get_app(__)
        else:
            return self.get_app(__)


    def build(self, __, app, entry):
        """Given a magic directory, an app, and an entry, return an app.

        This should only ever get called once per app in deployment mode, since
        in that mode we never invalidate cache entries once they are loaded, and
        they therefore never get rebuilt.

        The calls to verify* will raise an error if the objects do not implement
        the names interfaces.

        """

        zope.interface.verify.verifyObject(IApp, app)
        zope.interface.verify.verifyClass(ITransaction, app.Transaction)

        return app


    def get_app(self, __):
        """Get an app object to represent this application.

        For the root directory, we support automatically falling back to
        DefaultApp. Otherwise, we fail if there is no importable app. Also note
        that we influence sys.path here at import time to ensure that the
        correct app is found. We do this again at run time to ensure that any
        imports in Transaction.process are also interpreted properly.

        """

        if __ is None: # guaranteed by Config to only be true for the root
            return DefaultApp

        gaoler.capture(__)

        try:
            try:
                import app
                log(98, "Successfully imported %s from %s." % (app, __))
            finally:
                gaoler.release()

        except:
            log(90, "Failed to import app from %s." % __)
            raise

        return app
