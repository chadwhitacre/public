import unittest
from StringIO import StringIO
from email import message_from_string

from httpy.couplers.utils import make_deliver
from httpy.tests.utils import StubRequest

from httpy.tests.make_deliver.responders import responder, RESPONDER


FAILURE = message_from_string("""\
HTTP/1.0 500 Internal Server Error
Content-Length: 30
Content-Type: text/plain
Date: Wed, 22 Feb 2006 00:19:31 GMT
Server: httpy/0.9a

Internal Server Error""")


class Fail(unittest.TestCase):

    def setUp(self):
        make_request = StubRequest()
        self.out = StringIO()
        self.deliver = make_deliver(make_request, responder, self.out)

    def testBasic(self):
        self.deliver.fail()
        expected = FAILURE
        actual = message_from_string(self.out.getvalue())
        self.assertEqual(expected.keys(), actual.keys())
        self.assertEqual(expected.get_payload(), actual.get_payload())

