import imp
import os
import sys

from httpy import log
from httpy.Request import Request
from httpy.Response import Response


class HandlerRequestMixin:
    """This object contains request-side logic for the Handler class.
    """

    def get_transaction(self):
        """Return an instance of a Transaction appropriate to the request.

        The following conditions must be met, otherwise we default to
        httpy.app.Transaction:

            - The directory at app_root must have a subdirectory named `__'.
            - There must be a module `app.py', or a package `app', in `__'.
            - The app module/package must have a `Transaction' class.
            - app.Transaction must have a callable named `process'.


        This method started life as the example at:

            http://www.python.org/doc/2.4.1/lib/examples-imp.html

        """

        # If we are in development mode, refresh all modules.
        # ===================================================
        #
        # if self.config['mode'] == 'development':
        #     "http://pyunit.sourceforge.net/notes/reloading.html"


        app_root, __ = self.translate( self.server.config['root']
                                     , self.server.config['apps']
                                     , self.request_.path
                                      )

        if not __:
            log(95, "No magic directory found at %s. Falling back " % __ +
                    "to httpy.app")
            app = httpy.app
        else:
            log(98, "Found magic directory at %s; will look for app." % __)
            app = None


        if not app:

            # Fast path: see if the module has already been imported.
            try:
                return sys.modules['app']
            except KeyError:
                pass

            try:
                fp, pathname, description = imp.find_module('app', [__])
                app = imp.load_module('app', fp, pathname, description)
            except ImportError:
                log(95, "Unable to import app from %s. " % __ +
                        "Falling back to httpy.app.")
                app = httpy.app

            if not hasattr(app, 'Transaction'):
                log(91, "Unable to import Transaction from app at " +
                        "%s. Falling back to httpy.app." % __)
                app = httpy.app

            if not hasattr(app.Transaction, 'process'):
                log(91, "The app.Transaction in %s does not have " % __ +
                        "a `process' method. Falling back to httpy.app.")
                app = httpy.app

            if not callable(app.Transaction.process):
                log(91, "app.Transaction.process from %s is not " % __ +
                        "callable. Falling back to httpy.app.")
                app = httpy.app


        # Let the application influence configuration if it wants to.
        # ===========================================================
        # But we get the final say on app_root and __.

        if not hasattr(app, 'configure'):
            log(95, "Application at %s provides no local " % __ +
                    "configuration.")
        else:
            log(98, "Found local configuration for application at " +
                    "%s." % app_root)
            self.config = app.configure(self.config)

        self.config['root'] = app_root
        self.config['__'] = __


        # Return an instance of the transaction.
        # ======================================

        log(98, "Found a transaction to use: %s." % str(app.Transaction))
        return app.Transaction(self.config)


    def translate(self, root, apps, path):
        """Map the requested path to the filesystem.

        This function takes a website's filesystem-root, a list of application URI-
        roots, and the requested URI-path. It returns the filesystem-root of the
        application to be used for this request, and the filesystem-path of the
        application's magic directory, or None if the application does not have a
        magic directory.

        """

        # Find an application directory that matches the requested URI-path.
        # ==================================================================
        # The website root is always an implicit application. The first-named app
        # will match first.

        app = '/'
        for _app in apps:
            if path.startswith(_app):
                app = _app
                break
        app_root = os.path.realpath(os.path.join(root, app.lstrip('/')))
        path = os.path.realpath(os.path.join(app_root, path.lstrip('/')))

        if not os.path.isdir(app_root):
            # This can happen if an app dir is changed after httpy is started.
            raise Response(404)
        if not path.startswith(app_root):
            # protect against '../../../../../../../../../../etc/master.passwd'
            raise Response(403)


        # Look for a magic directory in the app directory, and protect it.
        # ================================================================

        __ = os.path.join(app_root, '__')
        if not os.path.isdir(__):
            __ = None
        if __ and path.startswith(__):
            raise Response(404)


        return (app_root, __)
