"""Disk And Execution MONitor (daemon) support.
"""
import os
import resource
import sys


UMASK = 0
WORKDIR = "/"
MAXFD = 1024
if (hasattr(os, "devnull")):
    DEVNULL = os.devnull
else:
    DEVNULL = "/dev/null"


def daemonize():
    """Daemonize the current process.

        See: http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/278731

    """

    # Fork the first child.
    # =====================

    try:
        pid = os.fork()
    except OSError, e:
        raise Exception, "%s [%d]" % (e.strerror, e.errno)

    if pid == 0:

        # Take over the new session and process group.
        # ============================================

        os.setsid()


        # Fork the second child.
        # ======================

        try:
            pid = os.fork()
        except OSError, e:
            raise Exception, "%s [%d]" % (e.strerror, e.errno)

        if pid != 0:

            # Exit parent of the second child (i.e., the first child).
            # ========================================================

            os._exit(0)


    else:

        # Exit parent of the first child.
        # ===============================

        os._exit(0)


    # Clean up the new process.
    # =========================
    #  - Change the current working directory and file mode creation mask.
    #  - Close all open file descriptors.
    #  - Redirect the standard I/O file descriptors to /dev/null.

    os.chdir(WORKDIR)
    os.umask(UMASK)

    maxfd = resource.getrlimit(resource.RLIMIT_NOFILE)[1]
    if (maxfd == resource.RLIM_INFINITY):
        maxfd = MAXFD
    for fd in range(0, maxfd):
        try:
            os.close(fd)
        except OSError:	# fd wasn't open to begin with
            pass

    os.open(DEVNULL, os.O_RDWR)	    # standard input (0)
    os.dup2(0, 1)			        # standard output (1)
    os.dup2(0, 2)			        # standard error (2)

    return(0)
