class AccessLogger:
    """Based on zope.server.http.commonaccesslogger.CommonAccessLogger.

    We might have trouble getting the socket from an httpy responder. The answer 
    might be to provide in- and outbound hooks in httpy.
    
    access_logger.log(self.out.addr[0], self.request, response)

    """

    def compute_timezone_for_log(self, tz):
        if tz > 0:
            neg = 1
        else:
            neg = 0
            tz = -tz
        h, rem = divmod (tz, 3600)
        m, rem = divmod (rem, 60)
        if neg:
            return '-%02d%02d' % (h, m)
        else:
            return '+%02d%02d' % (h, m)

    tz_for_log = None
    tz_for_log_alt = None

    def log_date_string(self, when):
        logtime = time.localtime(when)
        Y, M, D, h, m, s = logtime[:6]

        if not time.daylight:
            tz = self.tz_for_log
            if tz is None:
                tz = self.compute_timezone_for_log(time.timezone)
                self.tz_for_log = tz
        else:
            tz = self.tz_for_log_alt
            if tz is None:
                tz = self.compute_timezone_for_log(time.altzone)
                self.tz_for_log_alt = tz

        return '%d/%s/%02d:%02d:%02d:%02d %s' % (
            D, monthname[M], Y, h, m, s, tz)

    def log(self, IP, request, response):
        """Given an IP, a Request and a Response, log the resource access.
        """
        now = time.time()

        user_name = '-' # task.auth_user_name or 'anonymous'
        user_agent = request.headers.get('USER_AGENT', '')
        referer = request.headers.get('REFERER', '')

        args = ( IP
               , user_name
               , self.log_date_string(now)
               , request.raw_line
               , response.code
               , response.headers['Content-Length']
               , request.headers.get('Referer', '')
               , request.headers.get('User-Agent', '')
                )

        sys.stdout.write('%s - %s [%s] "%s" %s %d "%s" "%s"\n' % args)
        sys.stdout.flush()


access_logger = AccessLogger()

