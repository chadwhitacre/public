from SocketServer import ThreadingTCPServer
import os

import httpy
from httpy.Handler import Handler


class Server(ThreadingTCPServer):
    """An httpy server.

    Instantiate with a Config object, and start it with start().

    """

    version = (1, 1)
    version_string = "HTTP/1.1"
    response_header = "httpy/0.3"

    def __init__(self, config):

        self.config = config
        os.environ["HTTPY_VERBOSITY"] = str(self.config['verbosity'])
        addr = (self.config['ip'], self.config['port'])
        if self.config['mode'] == 'development':
            self.allow_reuse_address = True

        ThreadingTCPServer.__init__(self, addr, Handler)


    def start(self):
        httpy.log(90, "server started")
        try:
            self.serve_forever()
        except KeyboardInterrupt:
            httpy.log(90, "server stopped")
        except:
            httpy.log(1, "server killed")
