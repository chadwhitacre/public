import asyncore
import os

from zope.server.serverbase import ServerBase
from zope.server.taskthreads import ThreadedTaskDispatcher

from httpy import log
from httpy.Handler import Channel
from httpy.Request import Request


class Server(ServerBase):
    """An httpy server.

    Instantiate with a Config object, and start it with start().

    """

    # ServerBase boilerplate
    channel_class = Channel
    SERVER_IDENT = 'httpy'


    http_version = (1, 1)
    http_version_string = "HTTP/1.1" # Not actually true yet. :-(
    response_header = "httpy/0.3"


    def __init__(self, config):
        """Takes a dictionary as produced by httpy.Config.ossify.

        We stick verbosity in the environment so that httpy.log can use it.

        """

        self.config = config
        os.environ["HTTPY_VERBOSITY"] = str(self.config['verbosity'])

        td = ThreadedTaskDispatcher()
        td.setThreadCount(1)

        ServerBase.__init__( self
                           , config['ip']
                           , config['port']
                           , start=0
                           , task_dispatcher=td
                            )


    def start(self):
        self.accept_connections()
        try:
            log(90, 'starting server on ...')
            asyncore.loop(timeout=5)
        except KeyboardInterrupt:
            log(90, 'shutting down...')
            self.task_dispatcher.shutdown()


"""
TODO

signal handling (SIGHUP -- refresh config; SIGINT -- shutdown, etc.)

"""
