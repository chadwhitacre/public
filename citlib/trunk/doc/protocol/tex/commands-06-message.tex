\section{Message Commands}



\subsection{ASYN (ASYNchronous message support)}

 Negotiate the use of asynchronous, or unsolicited, protocol messages.  The
only parameter specified should be 1 or 0 to indicate that the client can or
cannot handle this type of messages.  The server will reply OK followed by a
1 or 0 to tell the client which mode it is now operating in.

 If the command is not available on the server (i.e. it returns ERROR), or
if the command has not been executed by the client, it should be assumed that
this mode of operation is NOT in effect.

 The client may also send any value other than 0 or 1 to simply cause the
server to output its current state without changing it.

 When asynchronous protocol mode is in effect, the client MUST handle any
asynchronous messages as they arrive, before doing anything else.



\subsection{DELE (DELEte a message)}

 Delete a message from the current room.  The one argument that should be
passed to this command is the message number of the message to be deleted.
The return value will be OK if the message was deleted, or an ERROR code.
If the delete is successful, the message's reference count is decremented, and
if the reference count reaches zero, the message is removed from the message
base.



\subsection{EMSG (Enter a system MeSsaGe)}

 This is the opposite of the MESG command - it allows the creation and editing
of system messages.  The only argument passed to EMSG is the name of the
file being transmitted.  If the file exists in any system message directory
on the server it will be overwritten, otherwise a new file is created.  EMSG
returns SEND_LISTING on success or ERROR+HIGHER_ACCESS_REQUIRED if the user
is not an Aide.

 Typical client software would use MESG to retrieve any existing message into
an edit buffer, then present an editor to the user and run EMSG if the changes
are to be saved.



\subsection{*ENT0 (ENTer message, mode 0)}

 This command is used to enter messages into the system.  It accepts four
arguments:

  0  -  Post flag.  This should be set to 1 to post a message.  If it is
set to 0, the server only returns OK or ERROR (plus any flags describing
the error) without reading in a message.  Client software should, in fact,
perform this operation at the beginning of an "enter message" command
*before* starting up its editor, so the user does not end up typing a message
in vain that will not be permitted to be saved.  If it is set to 2, the
server will accept an "apparent" post name if the user is privileged enough.
This post name is arg 5.
  1  -  Recipient (To: field).  This argument is utilized only for private
mail.  It is ignored for public messages.  It contains, of course, the name
of the recipient(s) of the message.
  2  -  Anonymous flag.  This argument is ignored unless the room allows
anonymous messages.  In such rooms, this flag may be set to 1 to flag a
message as anonymous, otherwise 0 for a normal message.
  3  -  Format type.  Any valid Citadel format type may be used (this will
typically be 0; see the MSG0 command above).
  4  -  Subject.  If present, this argument will be used as the subject of
the message.
  5  -  Post name.  When postflag is 2, this is the name you are posting as.
This is an Aide only command.
  6  -  Do Confirmation.  NOTE: this changes the protocol semantics!  When
you set this to nonzero, ENT0 will reply with a confirmation message after
you submit the message text.  The reply code for the ENT0 command will be
START_CHAT_MODE instead of SEND_LISTING.
  7  -  Recipient (Cc: field).  This argument is utilized only for private
mail.  It is ignored for public messages.  It contains, of course, the name
of the recipient(s) of the message.
  8  -  Recipient (Bcc: field).  This argument is utilized only for private
mail.  It is ignored for public messages.  It contains, of course, the name
of the recipient(s) of the message.

 Possible result codes:
  OK  -  The request is valid.  (Client did not set the "post" flag, so the
server will not read in message text.)   If the message is an e-mail with
a recipient, the text that follows the OK code will contain the exact name
to which mail is being sent.  The client can display this to the user.  The
implication here is that the name that the server returns will contain the
correct upper and lower case characters.  In addition, if the recipient is
having his/her mail forwarded, the forwarding address will be returned.
  SEND_LISTING  -  The request is valid.  The client should now transmit
the text of the message (ending with a 000 on a line by itself, as usual).
  START_CHAT_MODE  -  The request is valid.  The client should now transmit
the text of the message, ending with a 000 on a line by itself.  After
transmitting the 000 terminator, the client MUST read in the confirmation
from the server, which will also end with 000 on a line by itself.  The format
of the confirmation appears below.
  ERROR + NOT_LOGGED_IN  -  Not logged in.
  ERROR + HIGHER_ACCESS_REQUIRED  -  Higher access is required.  An
explanation follows, worded in a form that can be displayed to the user.
  ERROR + NO_SUCH_USER  -  The specified recipient does not exist.

The format of the confirmation message, if requested, is as follows:
Line 1: The new message number on the server for the message.  It will be
        positive for a real message number, or negative to denote
        that an error occurred.  If an error occurred, the message was
        not saved.
Line 2: A human-readable confirmation or error message.
Line 3: The resulting Exclusive UID of the message, if present.
(More may be added to this in the future, so do not assume that there will
only be these lines output.  Keep reading until 000 is received.)



\subsection{*GPEX (Get Policy for message EXpiration)}

 Returns the policy of the current room, floor, or site regarding the automatic
purging (expiration) of messages.  The following policies are available:
   0  -  Fall back to the policy of the next higher level.  If this is a room,
         use the floor's default policy.  If this is a floor, use the system
         default policy.  This is an invalid value for the system policy.
   1  -  Do not purge messages automatically.
   2  -  Purge by message count.  (Requires a value: number of messages)
   3  -  Purge by message age.  (Requires a value: number of days)

 The format of this command is:  GPEX <which>
 The value of <which> must be one of: "room" "floor" "site" "mailboxes"

 If successful, GPEX returns OK followed by <policy>|<value>.



\subsection{GTSN (GeT the list of SeeN messages)}

 This command retrieves the list of "seen" (as opposed to unread) messages for
the current room.  It returns OK followed by an IMAP-format message list.



\subsection{FSCK (check message base reference counts)}

 Verify, via the long way, that all message reference counts are correct.  If
the user has permission to do this then LISTING_FOLLOWS is returned, followed
by a transcript of the run.  Otherwise ERROR is returned.



\subsection{*MESG (read system MESsaGe)}

 This command is used to display system messages and/or help files.  The
single argument it accepts is the name of the file to display.  IT IS CASE
SENSITIVE.  Citadel looks for these files first in the "messages"
subdirectory and then in the "help" subdirectory.

 If the file is found, LISTING_FOLLOWS is returned, followed by a pathname
to the file being displayed.  Then the message is printed, in format type 0
(see MSG0 command for more information on this).  If the file is not found,
ERROR is returned.

 There are some "well known" names of system messages which client software
may expect most servers to carry:

 hello        -  Welcome message, to be displayed before the user logs in.
 changepw     -  To be displayed whenever the user is prompted for a new
                 password.  Warns about picking guessable passwords and such.
 register     -  Should be displayed prior to the user entering registration.
                 Warnings about not getting access if not registered, etc.
 help         -  Main system help file.
 goodbye      -  System logoff banner; display when user logs off.
 roomaccess   -  Information about how public rooms and different types of
                 private rooms function with regards to access.
 unlisted     -  Tells users not to choose to be unlisted unless they're
                 really paranoid, and warns that aides can still see
                 unlisted userlog entries.

 Citadel provides these for the Citadel Unix text client.  They are
probably not very useful for other clients:

 mainmenu     -  Main menu (when in idiot mode).
 aideopt      -  .A?
 readopt      -  .R?
 entopt       -  .E?
 dotopt       -  .?
 saveopt      -  Options to save a message, abort, etc.
 entermsg     -  Displayed just before a message is entered, when in
                 idiot mode.



\subsection{*MOVE (MOVE or copy a message to a different room)}

 Move or copy a message to a different room.  This command expects to be
passed three arguments:
 0: the message number of the message to be moved or copied.
 1: the name of the target room.
 2: flag: 0 to move the message, 1 to copy it without deleting from the
    source room.

 This command never creates or deletes copies of a message; it merely moves
around links.  When a message is moved, its reference count remains the same.
When a message is copied, its reference count is incremented.




\subsection{*MSGS (get pointers to MeSsaGeS in this room)}

 This command obtains a listing of all the messages in the current room
which the client may request.  This command may be passed a single parameter:
either "all", "old", or "new" to request all messages, only old messages, or
new messages.  Or it may be passed two parameters: "last" plus a number, in
which case that many message pointers will be returned; "first" plus a
number, for the corresponding effect; or "gt" plus a number, to list all
messages in the current room with a message number greater than the one
specified.  If no parameters are specified, "all" is assumed.

 The third argument, may be either 0 or 1.  If it is 1, this command behaves
differently: before a listing is returned, the client must transmit a list
of fields to search for.  The field headers are listed below in the writeup
for the "MSG0" command.

 The optional fourth argument may also be either 0 or 1.  If it is 1, the
output of this command will include not only a list of message numbers, but
a simple header summary of each message as well.  This is somewhat resource
intensive so you shouldn't do this unless you absolutely need all the headers
immediately.  The fields which are output (in the usual delimited fashion, of
course) are: message number, timestamp, display name, node name, Internet
email address (if present), subject (if present).

 This command can return three possible results.  ERROR + NOT_LOGGED_IN will
be returned if no user is currently logged in.  Otherwise, LISTING_FOLLOWS
will be returned, and the listing will consist of zero or more message
numbers, one per line.  The listing ends, as always, with the string "000"
alone on a line by itself.  The listed message numbers can be used to request
messages from the system.  If "search mode" is being used, the server will
return START_CHAT_MODE, and the client is expected to transmit the search
criteria, and then read the message list.

 Since this is somewhat complex, here are some examples:

 Example 1: Read all new messages

 Client:   MSGS NEW
 Server:   100 Message list...
           523218
           523293
           523295
           000

 Example 2: Read the last five messages

 Client:   MSGS LAST|5
 Server:   100 Message list...
           523190
           523211
           523218
           523293
           523295
           000

 Example 3: Read all messages written by "IGnatius T Foobar"

 Client:   MSGS ALL|0|1
 Server:   800 Send template then receive message list
 Client:   from|IGnatius T Foobar
           000
 Server:   518604
           519366
           519801
           520201
           520268
           520805
           520852
           521579
           521720
           522571
           000

 Note that in "search mode" the client may specify any number of search
criteria.  These criteria are applied with an AND logic.



\subsection{*MSG0 (read MeSsaGe, mode 0)}

 This is a command used to read the text of a message.  "Mode 0" implies that
other MSG commands (MSG1, MSG2, etc.) will probably be added later on to read
messages in more robust formats.  This command should be passed two arguments.
The first is the message number of the message being requested.  The second
argument specifies whether the client wants headers and/or message body:
 0 = Headers and body
 1 = Headers only
 2 = Body only
 3 = Headers only, with MIME information suppressed (this runs faster)

 If the request is denied, ERROR + NOT_LOGGED_IN or ERROR + MESSAGE_NOT_FOUND
will be returned.  Otherwise, LISTING_FOLLOWS will be returned, followed by
the contents of the message.  The following fields may be sent:

 type=   Formatting type.  The currently defined types are:
  0 = "traditional" Citadel formatting.  This means that newlines should be
treated as spaces UNLESS the first character on the next line is a space.  In
other words, only indented lines should generate a newline on the user's screen
when the message is being displayed.  This allows a message to be formatted to
the reader's screen width.  It also allows the use of proportional fonts.
  1 = a simple fixed-format message.  The message should be displayed to
the user's screen as is, preferably in a fixed-width font that will fit 80
columns on a screen.
  4 = MIME format message.  The message text is expected to contain a header
with the "Content-type:" directive (and possibly others).

 msgn=   The message ID of this message on the system it originated on.
 path=   An e-mailable path back to the user who wrote the message.

 time=   The date and time of the message, in Unix format (the number of
seconds since midnight on January 1, 1970, GMT).

 from=   The name of the author of the message.
 rcpt=   If the message is a private e-mail, this is the recipient.
 room=   The name of the room the message originated in.
 node=   The short node name of the system this message originated on.
 hnod=   The long node name of the system this message originated on.
 zaps=   The id/node of a message which this one zaps (supersedes).

 part=   Information about a MIME part embedded in this message.
 pref=   Information about a multipart MIME prefix such as "multipart/mixed"
         or "multipart/alternative".  This will be output immediately prior
         to the various "part=" lines which make up the multipart section.
 suff=   Information about a multipart MIME suffix.  This will be output
         immediately following the various "part=" lines which make up the
         multipart section.

 text    Note that there is no "=" after the word "text".  This string
signifies that the message text begins on the next line.



\subsection{MSG1 (read MeSsaGe, mode 1)}

 This command is not currently used.



\subsection{MSG2 (read MeSsaGe, mode 2)}

 MSG2 follows the same calling convention as MSG0.  The difference between
the two commands is that MSG2 outputs messages in standard RFC822 format
rather than in Citadel proprietary format.

 This command was implemented in order to make various gateway programs
easier to implement, and to provide some sort of multimedia support in the
future.  Keep in mind that when this command is used, all messages will be
output in fixed 80-column format.



\subsection{MSG3 (read MeSsaGe, mode 3 -- internal command)}

 MSG3 is for use by internal programs only and should not be utilized by
user-mode clients.  It does require IPGM authentication.  MSG3 follows the
same calling convention as the other MSG commands, but upon success returns
BINARY_FOLLOWS followed by a data block containing the _raw_ message format
on disk.



\subsection{MSG4 (read MeSsaGe, mode 4 -- output in preferred MIME format)}

 This is the equivalent of MSG0, except it's a bit smarter about messages in
rich text formats.  Immediately following the "text" directive, the server
will output RFC822-like MIME part headers such as "Content-type:" and
"Content-length:".  MIME formats are chosen and/or converted based on the
client's preferred format settings, which are set using the MSGP command,
described below.



\subsection{MSGP (set MeSsaGe Preferred MIME format)}

 Client tells the server what MIME content types it knows how to handle, and
the order in which it prefers them.  This is similar to an HTTP "Accept:"
header.

 The parameters to a MSGP command are the client's acceptable MIME content
types, in the order it prefers them (from most preferred to least preferred).
For example:  MSGP text/html|text/plain

 The MSGP command always returns OK.



\subsection{OPNA (OPeN Attachment)}

 Opens, as a download file, a component of a MIME-encoded message.  The two
parameters which must be passed to this command are the message number and the
name of the desired section.  If the message or section does not exist, an
appropriate ERROR code will be returned; otherwise, if the open is successful,
this command will succeed returning the same information as an OPEN command.



\subsection{SEEN (set or clear the SEEN flag for a message)}

 Beginning with version 5.80, Citadel supports the concept of setting or
clearing the "seen" flag for each individual message, instead of only allowing
a "last seen" pointer.  In fact, the old semantics are implemented in terms
of the new semantics.  This command requires two arguments: the number of the
message to be set, and a 1 or 0 to set or clear the "seen" bit.

 This command returns OK, unless the user is not logged in or a usage error
occurred, in which case it returns ERROR.  Please note that no checking is
done on the supplied data; if the requested message does not exist, the SEEN
command simply returns OK without doing anything.



\subsection{SPEX (Set Policy for message EXpiration)}

 Sets the policy of the current room, floor, or site regarding the automatic
purging (expiration) of messages.  See the writeup for the GPEX command for
the list of available policies.

 The format of this command is:  SPEX <which>|<policy>|<value>
 The value of <which> must be one of: "room" "floor" "site" "mailboxes"

 If successful, GPEX returns OK; otherwise, an ERROR code is returned.



\subsection{SRCH (SeaRCH the message base)}

 This command's implementation is incomplete and will be documented when it
is finished.  The current implementation accepts a search string as its sole
argument, and will respond with LISTING_FOLLOWS followed by a list of
messages (globally, not just in the current room) which contain ALL of the
words in the search string.  If the client desires an "exact phrase" match,
it must then slow-search the text of each returned message for the exact
string.  The client should also compare the returned message numbers against
those which actually exist in the room or rooms being searched.  In
particular, clients should avoid telling the user about messages which exist
only in rooms to which the user does not have access.

 Again, keep in mind that this is a temporary implementation and is not
guaranteed to continue to exist in this form.


