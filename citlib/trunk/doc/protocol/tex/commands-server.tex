\section{Server Commands}



\subsection{*CONF (get or set global CONFiguration options)}

 Retrieves or sets various system-wide configuration and policy options.  This
command is only available to Aides.  The sole parameter accepted is a command,
which should be either GET or SET.  If the GET command succeeds, CONF will
return LISTING_FOLLOWS followed by the fields described below, one line at a
time.  If the SET command succeeds, CONF will return SEND_LISTING and expect
the fields described below, one line at a time (don't worry about other fields
being added in the future; if a 'short' configuration list is sent, the missing
values at the end will be left unchanged on the system).  If either command
fails for any reason, ERROR is returned.

 The configuration lines are as follows:

 1. Node name
 2. Fully qualified domain name
 3. Human-readable node name
 4. Landline telephone number of this system
 5. Flag (0 or 1) - creator of private room automatically becomes room aide
 6. Server connection idle timeout (in seconds)
 7. Initial access level for new users
 8. Flag (0 or 1) - require registration for new users
 9. Flag (0 or 1) - automatically move Problem User messages to twit room
 10. Name of twit room
 11. Text of <more> prompt
 12. Flag (0 or 1) - restrict access to Internet mail
 13. Geographic location of this system
 14. Name of the system administrator
 15. Number of maximum concurrent sessions allowed on the server
 16. (placeholder -- this field is no longer in use)
 17. Default purge time (in days) for users
 18. Default purge time (in days) for rooms
 19. Name of room to log instant messages to (or a zero-length name for none)
 20. Access level required to create rooms
 21. Maximum message length which may be entered into the system
 22. Minimum number of worker threads
 23. Maximum number of worker threads
 24. Port number for POP3 service
 25. Port number for SMTP service
 26. Flag (0 or 1) - strict RFC822 adherence - don't correct From: forgeries
 27. Flag (0 or 1) - allow Aides to zap (forget) rooms
 28. Port number for IMAP service
 29. How often (in seconds) to run the networker
 30. Flag (0 or 1) - disable self-service new user registration
 31. (placeholder -- this field is no longer in use)
 32. Hour (0 through 23) during which database auto-purge jobs are run
 33. Name of host where an LDAP service may be found
 34. Port number of LDAP service on above host
 35. LDAP Base DN
 36. LDAP Bind DN
 37. Password for LDAP Bind DN
 38. Server IP address to listen on (or "0.0.0.0" for all addresses)
 39. Port number for SMTP MSA service
 40. Port number for IMAPS (SSL-encrypted IMAP)
 41. Port number for POP3S (SSL-encrypted POP3)
 42. Port number for SMTPS (SSL-encrypted SMTP)
 43. Flag (0 or 1) - enable full text search index
 44. Flag (0 or 1) - automatically cull database log files
 45. Flag (0 or 1) - enable IMAP "instant expunge" of deleted messages
 46. Flag (0 or 1) - allow unauthenticated SMTP clients to spoof my domains

 CONF also accepts two additional commands: GETSYS and PUTSYS followed by an
arbitrary MIME type (such as application/x-citadel-internet-config) which
provides a means of storing generic configuration data in the Global System
Configuration room without the need to add extra get/set commands to the
server.

 Please note that the LDAP-specific configs have no effect on Citadel servers
in which LDAP support is not enabled.



\subsection{ECHO (ECHO something)}

 This command does nothing.  It simply returns OK followed by whatever
its arguments are.



\subsection{*GTLS (Get Transport Layer Security Status)}

 This command returns information about the current connection.  The server
returns OK plus several parameters if the connection is encrypted, and ERROR
if the connection is not encrypted.  It is primarily used for debugging.  The
command may be run at any time.

 0 - Protocol name, e.g. "SSLv3"
 1 - Cipher suite name, e.g. "ADH-RC4-MD5"
 2 - Cipher strength bits, e.g. 128
 3 - Cipher strength bits actually in use, e.g. 128



\subsection{IDEN (IDENtify the client software)}

 The client software has the option to identify itself to the server.
Currently, the server does nothing with this information except to write
it to the syslog to satisfy the system administrator's curiosity.  Other
uses might become apparent in the future.

 The IDEN command should contain five fields: a developer ID number (same as
the server developer ID numbers in the INFO command -- please obtain one if
you are a new developer), a client ID number (which does not have to be
globally unique - only unique within the domain of the developer number),
a version number, a free-form text string describing the client, and the name
of the host the user is located at.

 It is up to the server to determine whether to accept the host name or to
use the host name it has detected itself.  Generally, if the client is
running on a trusted host (either localhost or a well-known publically
accessible client) it should use the host name transmitted by IDEN,
otherwise it should use the host name it has detected itself.

 IDEN always returns OK, but since that's the only way it ever returns
there's no point in checking the result code.



\subsection{*INFO (get server INFO)}

 This command will *always* return LISTING_FOLLOWS and then print out a
listing of zero or more strings.  Client software should be written to expect
anywhere from a null listing to an infinite number of lines, to allow later
backward compatibility.  The current implementation defines the following
parts of the listing:

 Line 1  - Your unique session ID on the server
 Line 2  - The node name of the Citadel server
 Line 3  - Human-readable node name of the Citadel server
 Line 4  - The fully-qualified domain name (FQDN) of the server
 Line 5  - The name of the server software, i.e. "Citadel 4.00"
 Line 6  - (The revision level of the server code) * 100
 Line 7  - The geographical location of the site (city and state if in the US)
 Line 8  - The name of the system administrator
 Line 9  - A number identifying the server type (see below)
 Line 10 - The text of the system's paginator prompt
 Line 11 - Floor Flag.  1 if the system supports floors, 0 otherwise.
 Line 12 - Paging level.  0 if the system only supports inline paging,
           1 if the system supports "extended" paging (check-only and
           multiline modes).  See the SEXP command for further information.
 Line 13 - The "nonce" for this session, for support of APOP-style
           authentication.  If this field is present, clients may authenticate
           in this manner.
 Line 14 - Set to nonzero if this server supports the QNOP command.
 Line 15 - Set to nonzero if this server is capable of connecting to a
           directory service using LDAP.

 *** NOTE! ***   The "server type" code is intended to promote global
compatibility in a scenario in which developers have added proprietary
features to their servers or clients.  We are attempting to avoid a future
situation in which users need to keep different client software around for
each Citadel they use.  *Please*, if you are a developer and plan to add
proprietary features:

 -> Your client programs should still be able to utilize servers other than
your own.
 -> Clients other than your own should still be able to utilize your server,
even if your proprietary extensions aren't supported.
 -> Please contact Art Cancro <ajc@uncensored.citadel.org> and obtain a unique
server type code, which can be assigned to your server program.
 -> If you document what you did in detail, perhaps it can be added to a
future release of the Citadel program, so everyone can enjoy it.  Better
yet, just work with the Citadel development team on the main source tree.

 If everyone follows this scheme, we can avoid a chaotic situation with lots
of confusion about which client program works with which server, etc.  Client
software can simply check the server type (and perhaps the revision level)
to determine ahead of time what commands may be utilized.

 Please refer to "developers.txt" for information on what codes belong to whom.



\subsection{IPGM (identify as an Internal ProGraM)}

 IPGM is a low-level command that should not be used by normal user clients.
It is used for various utilities to communicate with the server on the same
host.  For example, the "sendcommand" utility logs onto the server as an
internal program in order to run arbitrary server commands.  Since user clients
do not utilize this command (or any of its companion commands), developers
writing Citadel-compatible servers need not implement it.

 The sole argument to IPGM is the system's internal program password.  This
password is generated by the setup program and stored in the config file.
Since internal programs have access to the config file, they know the correct
password to use.

 IPGM returns OK for a correct authentication or ERROR otherwise.



\subsection{*MRTG (Multi Router Traffic Grapher)}

 Multi Router Traffic Grapher (please see http://www.mrtg.org for more info) is
a tool which creates pretty graphs of network activity, usually collected from
routers using SNMP.  However, its ability to call external scripts has spawned
a small community of people using it to graph anything which can be graphed.
The MRTG command can output Citadel server activity in the format MRTG expects.

 This format is as follows:

 LISTING_FOLLOWS
 Line 1: variable \#1
 Line 2: variable \#2
 Line 3: uptime of system
 Line 4: name of system
 000

 MRTG accepts two different keywords.  "MRTG users" will return two variables,
the number of connected users and the number of active users.  "MRTG messages"
will return one variable (and a zero in the second field), showing the current
highest message number on the system.  Any other keyword, or a missing keyword,
will cause the MRTG command to return an ERROR code.

 Please get in touch with the Citadel developers if you wish to experiment with
this.



\subsection{NETP (authenticate as network session with connection NET Password)}

 This command is used by client software to identify itself as a transport
session for Citadel site-to-site networking.  It should be called with
two arguments: the node name of the calling system, and the "shared secret"
password for that connection.  If the authentication succeeds, NETP will
return OK, otherwise, it returns ERROR.



\subsection{NOOP (NO OPeration)}

 This command does nothing.  It takes no arguments and always returns
OK.  It is intended primarily for testing and development, but it might also
be used as a "keep alive" command to prevent the server from timing out, if
it's running over a transport that needs this type of thing.



\subsection{QNOP (Quiet No OPeration)}

 This command does nothing, similar to the NOOP command.  However, unlike the
NOOP command, it returns *absolutely no response* at all.  The client has no
way of knowing that the command executed.  It is intended for sending
"keepalives" in situations where a full NOOP would cause the client protocol
to get out of sync.

 Naturally, sending this command to a server that doesn't support it is an
easy way to mess things up.  Therefore, client software should first check
the output of an INFO command to ensure that the server supports quiet noops.



\subsection{QUIT (QUIT)}

 Terminate the server connection.  This command takes no arguments.  It
returns OK and closes the connection immediately.




\subsection{REQT (REQuest client Termination)}

 Request that the specified client (or all clients) log off.  Aide level
access is required to run this command, otherwise ERROR+HIGHER_ACCESS_REQUIRED
is returned.

 The REQT command accepts one parameter: the session ID of the client which
should be terminated, or 0 for all clients.  When successful, the REQT command
returns OK.

It should be noted that REQT simply transmits an instant message to the
specified client(s) with the EM_GO_AWAY flag set.  Older clients do not honor
this flag, and it is certainly possible for users to re-program their client
software to ignore it.  Therefore the effects of the REQT command should be
considered advisory only.  The recommended implementation practice is to first
issue a REQT command, then wait a little while (from 30 seconds up to a few
minutes) for well-behaved clients to voluntarily terminate, and then issue a
TERM command to forcibly disconnect the client (or perhaps a DOWN command, if
you are logging off users for the purpose of shutting down the server).



\subsection{STLS (Start Transport Layer Security)}

 This command starts TLS on the current connection.  The current
implementation uses OpenSSL on both the client and server end.  For future
compatibility all clients must support at least TLSv1, and servers are
guaranteed to support TLSv1.  During TLS negotiation (see below) the server
and client may agree to use a different protocol.

 The server returns ERROR if it does not support SSL or SSL initialization
failed on the server; otherwise it returns OK.  Once the server returns OK and
the client has read the response, the server and client immediately negotiate
TLS (in OpenSSL, using SSL_connect() on the client and SSL_accept() on the
server).  If negotiation fails, the server and client should attempt to resume
the session unencrypted.  If either end is unable to resume the session, the
connection should be closed.

 This command may be run at any time.


